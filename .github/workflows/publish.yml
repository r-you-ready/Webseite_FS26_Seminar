name: Render and Publish Quarto Website

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      RENV_CONFIG_AUTOLOADER_ENABLED: "FALSE"
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true
          
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libcurl4-openssl-dev libssl-dev libxml2-dev \
            libfontconfig1-dev libfreetype6-dev \
            libharfbuzz-dev libfribidi-dev \
            libpng-dev libtiff5-dev libjpeg-dev libwebp-dev

      - name: Disable renv (remove folder)
        run: rm -rf renv renv.lock

      - name: Detect R packages used in qmd/R files
        run: |
          Rscript -e '
          files <- c(
            list.files(".", pattern="\\.qmd$", recursive=TRUE, full.names=TRUE),
            list.files(".", pattern="\\.R$", recursive=TRUE, full.names=TRUE),
            list.files(".", pattern="\\.Rmd$", recursive=TRUE, full.names=TRUE)
          )
          files <- files[!grepl("^_site/|^\\.quarto/|^renv/|^\\.git/", files)]

          pkgs <- character()
          for (f in files) {
            txt <- tryCatch(readLines(f, warn = FALSE), error = function(e) character())
            m1 <- gregexpr("\\\\b(library|require)\\\\s*\\\\(\\\\s*([A-Za-z][A-Za-z0-9._]*)\\\\s*\\\\)", txt, perl=TRUE)
            hits1 <- regmatches(txt, m1)
            if (length(hits1)) for (h in unlist(hits1)) {
              pkgs <- c(pkgs, sub(".*\\\\(\\\\s*([A-Za-z][A-Za-z0-9._]*)\\\\s*\\\\).*", "\\\\1", h))
            }
            m2 <- gregexpr("\\\\b(library|require)\\\\s*\\\\(\\\\s*\\\"([^\\\"]+)\\\"\\\\s*\\\\)", txt, perl=TRUE)
            hits2 <- regmatches(txt, m2)
            if (length(hits2)) for (h in unlist(hits2)) {
              pkgs <- c(pkgs, sub(".*\\\"([^\\\"]+)\\\".*", "\\\\1", h))
            }
          }

          pkgs <- unique(pkgs)
          base_pkgs <- c("stats","graphics","grDevices","utils","datasets","methods","base","tools","compiler","parallel","grid","splines","tcltk")
          pkgs <- setdiff(pkgs, base_pkgs)

          pkgs <- unique(c("rmarkdown","knitr", pkgs))

          cat("Number of files scanned:", length(files), "\\n")
          cat("Detected packages:\\n")
          cat(paste0(" - ", pkgs, collapse="\\n"), "\\n")
          writeLines(pkgs, "ci-packages.txt")
          '

      - name: Install detected R packages
        run: |
          Rscript -e '
          repos <- "https://cloud.r-project.org"
          pkgs <- readLines("ci-packages.txt", warn=FALSE)

          # HARD ADD: make sure this is installed
          pkgs <- unique(c(pkgs, "palmerpenguins", "apaTables", "afex", "emmeans", "effectsize", "psych", "effsize", "skimr", "here", "styler"))

          avail <- rownames(available.packages(repos=repos))
          to_install <- intersect(pkgs, avail)
          missing <- setdiff(pkgs, avail)

          cat("Installing from CRAN:\n", paste(to_install, collapse=", "), "\n")
          if (length(missing)) cat("Not on CRAN (skipped):\n", paste(missing, collapse=", "), "\n")

          install.packages(to_install, repos=repos)
          '
          
      - name: Install GitHub-only R packages (if needed)
        env:
          GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
        run: |
          Rscript -e 'if (!requireNamespace("remotes", quietly=TRUE)) install.packages("remotes", repos="https://cloud.r-project.org")'
          Rscript -e 'if (!requireNamespace("chattr", quietly=TRUE)) remotes::install_github("mlverse/chattr", dependencies=TRUE)'

      - name: Render website
        run: quarto render

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4


